<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <title>Тест File Input</title>
    <style>
        body {
            background: #050505;
            color: white;
            font-family: Arial;
            padding: 40px;
        }

        #drop-zone {
            border: 2px dashed #FF8C42;
            padding: 40px;
            text-align: center;
            position: relative;
            background: #1a1a1a;
        }

        #file-input {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
            z-index: 10;
        }

        .log {
            background: #222;
            padding: 10px;
            margin: 10px 0;
            border-left: 3px solid #22c55e;
        }
    </style>
</head>

<body>
    <h1>Тест File Input - Упрощенная Копия Index.html</h1>
    <div id="logs"></div>

    <div id="drop-zone">
        <input type="file" id="file-input" accept=".pdf">
        <p>Кликните или перетащите PDF файл</p>
        <div id="loading-state" style="display: none;">Загрузка...</div>
    </div>

    <script>
        const logs = document.getElementById('logs');

        function log(msg) {
            const div = document.createElement('div');
            div.className = 'log';
            div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            logs.appendChild(div);
            console.log(msg);
        }

        log('Скрипт загружен');

        document.addEventListener('DOMContentLoaded', () => {
            log('DOMContentLoaded');

            const dropZone = document.getElementById('drop-zone');
            const fileInput = document.getElementById('file-input');
            const loadingState = document.getElementById('loading-state');

            log(`Элементы: dropZone=${!!dropZone}, fileInput=${!!fileInput}, loadingState=${!!loadingState}`);

            if (!fileInput) {
                log('ОШИБКА: fileInput не найден!');
                return;
            }

            // Обработчик change
            fileInput.addEventListener('change', (e) => {
                log('>>> СОБЫТИЕ CHANGE СРАБОТАЛО! <<<');
                log(`Файлов выбрано: ${e.target.files.length}`);

                const file = e.target.files[0];
                if (file) {
                    log(`Имя файла: ${file.name}`);
                    log(`Тип: ${file.type}`);
                    log(`Размер: ${file.size} байт`);

                    if (file.type === 'application/pdf') {
                        uploadFile(file);
                    } else {
                        log('ОШИБКА: Не PDF файл');
                    }
                }
            });

            log('Обработчик change добавлен');

            async function uploadFile(file) {
                log('>>> uploadFile() вызван');
                loadingState.style.display = 'block';

                const formData = new FormData();
                formData.append('file', file);

                try {
                    const token = localStorage.getItem('crisha_token');
                    const headers = {};
                    if (token) {
                        headers['Authorization'] = `Token ${token}`;
                    }

                    log('Отправка на сервер...');
                    const response = await fetch('http://127.0.0.1:8000/api/analyze/', {
                        method: 'POST',
                        body: formData,
                        headers: headers
                    });

                    log(`Ответ: ${response.status}`);

                    if (response.ok) {
                        const data = await response.json();
                        log('Успех! Данные получены');

                        setTimeout(() => {
                            log('РЕДИРЕКТ через 1 секунду...');
                            window.location.href = '/frontend/dashboard.html';
                        }, 1000);
                    } else {
                        log(`Ошибка сервера: ${response.status}`);
                    }
                } catch (error) {
                    log(`ОШИБКА: ${error.message}`);
                }
            }

            log('Инициализация завершена');
        });
    </script>
</body>

</html>